name: Build MJML Binaries

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  # Generate build matrix from config
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      version: ${{ steps.get-version.outputs.version }}
      release_exists: ${{ steps.check-release.outputs.exists }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Get version from package.json
        id: get-version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=v${VERSION}" >> "$GITHUB_OUTPUT"
          echo "ðŸ“¦ Package version: v${VERSION}"

      - name: Check if release already exists
        id: check-release
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ steps.get-version.outputs.version }}
        run: |
          if gh release view "$VERSION" --repo "${{ github.repository }}" > /dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "âš ï¸ Release $VERSION already exists"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "âœ… Release $VERSION does not exist - will create after build"
          fi

      - name: Generate Build Matrix
        id: set-matrix
        run: |
          node << 'EOF'
          const fs = require('fs');
          const config = JSON.parse(fs.readFileSync('config/build-config.json', 'utf8'));

          const runnerMap = {
            'macos-x64': 'macos-15',
            'macos-arm64': 'macos-15',
            'linux-x64': 'ubuntu-latest',
            'linux-arm64': 'ubuntu-latest',
            'windows-x64': 'windows-latest',
            'windows-arm64': 'windows-latest'
          };

          const matrix = { include: [] };

          for (const [platform, pConfig] of Object.entries(config.platforms)) {
            if (!pConfig.enabled) continue;

            for (const [nodeVer, nConfig] of Object.entries(config.nodeVersions)) {
              if (!nConfig.enabled || !nConfig.supported) continue;

              matrix.include.push({
                platform,
                node_version: nodeVer,
                pkg_target: nConfig.pkgTarget + '-' + pConfig.pkgTarget,
                runner: runnerMap[platform],
                artifact_name: pConfig.artifactName,
                extension: pConfig.extension || ''
              });
            }
          }

          const output = JSON.stringify(matrix);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, 'matrix=' + output + '\n');
          console.log('Build matrix:', matrix.include.length, 'targets');
          EOF

  # Build binaries
  build:
    needs: prepare
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build binary
        env:
          PKG_TARGET: ${{ matrix.pkg_target }}
          ARTIFACT_NAME: ${{ matrix.artifact_name }}
          NODE_VER: ${{ matrix.node_version }}
          EXT: ${{ matrix.extension }}
        shell: bash
        run: |
          mkdir -p dist
          npx @yao-pkg/pkg . --target "$PKG_TARGET" --output "dist/mjml-${ARTIFACT_NAME}-node${NODE_VER}${EXT}" --compress GZip

      - name: Generate hash (Unix)
        if: runner.os != 'Windows'
        env:
          ARTIFACT_NAME: ${{ matrix.artifact_name }}
          NODE_VER: ${{ matrix.node_version }}
          EXT: ${{ matrix.extension }}
        run: |
          cd dist
          BINARY_NAME="mjml-${ARTIFACT_NAME}-node${NODE_VER}${EXT}"
          shasum -a 256 "$BINARY_NAME" > "$BINARY_NAME.sha256"
          cat "$BINARY_NAME.sha256"

      - name: Generate hash (Windows)
        if: runner.os == 'Windows'
        env:
          ARTIFACT_NAME: ${{ matrix.artifact_name }}
          NODE_VER: ${{ matrix.node_version }}
          EXT: ${{ matrix.extension }}
        shell: pwsh
        run: |
          cd dist
          $binaryName = "mjml-$env:ARTIFACT_NAME-node$env:NODE_VER$env:EXT"
          $hash = (Get-FileHash -Algorithm SHA256 $binaryName).Hash.ToLower()
          "$hash  $binaryName" | Out-File -Encoding utf8 "$binaryName.sha256"
          Get-Content "$binaryName.sha256"

      - name: Test binary (Unix x64)
        if: runner.os != 'Windows' && !contains(matrix.platform, 'arm64')
        env:
          ARTIFACT_NAME: ${{ matrix.artifact_name }}
          NODE_VER: ${{ matrix.node_version }}
        run: |
          chmod +x "dist/mjml-${ARTIFACT_NAME}-node${NODE_VER}"
          echo '<mjml><mj-body><mj-section><mj-column><mj-text>Hello</mj-text></mj-column></mj-section></mj-body></mjml>' | "./dist/mjml-${ARTIFACT_NAME}-node${NODE_VER}" --stdin | head -20

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mjml-${{ matrix.platform }}-node${{ matrix.node_version }}
          path: |
            dist/mjml-${{ matrix.artifact_name }}-node${{ matrix.node_version }}${{ matrix.extension }}
            dist/mjml-${{ matrix.artifact_name }}-node${{ matrix.node_version }}${{ matrix.extension }}.sha256
          retention-days: 7

  # Verify all builds
  verify:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Verify hashes
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "                    Hash Verification                       "
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          FAILED=0
          COUNT=0

          for dir in artifacts/*/; do
            for sha_file in "$dir"*.sha256; do
              [ -f "$sha_file" ] || continue
              binary_name=$(basename "$sha_file" .sha256)
              binary_path="${dir}${binary_name}"

              if [ -f "$binary_path" ]; then
                expected=$(awk '{print $1}' "$sha_file")
                actual=$(sha256sum "$binary_path" | awk '{print $1}')
                COUNT=$((COUNT + 1))

                if [ "$expected" = "$actual" ]; then
                  echo "âœ… $binary_name"
                else
                  echo "âŒ $binary_name - HASH MISMATCH"
                  FAILED=1
                fi
              fi
            done
          done

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Verified: $COUNT binaries"

          if [ $FAILED -eq 1 ]; then
            echo "âŒ Verification FAILED"
            exit 1
          fi
          echo "âœ… All hashes verified"

  # Auto-release (only on main, only if release doesn't exist)
  release:
    needs: [prepare, build, verify]
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name != 'pull_request' &&
      needs.prepare.outputs.release_exists == 'false'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create ZIP packages
        run: |
          mkdir -p release

          for dir in artifacts/*/; do
            [ -d "$dir" ] || continue
            dir_name=$(basename "$dir")

            for binary in "$dir"*; do
              [ -f "$binary" ] || continue
              [[ "$binary" == *.sha256 ]] && continue

              binary_name=$(basename "$binary")
              zip_name="${binary_name}.zip"

              cd "$dir"
              zip -9 "../../release/$zip_name" "$binary_name" "${binary_name}.sha256" 2>/dev/null || \
              zip -9 "../../release/$zip_name" "$binary_name"
              cd - > /dev/null

              echo "ðŸ“¦ $zip_name"
            done
          done

      - name: Generate checksums
        run: |
          cd release
          sha256sum *.zip > SHA256SUMS.txt
          echo ""
          echo "SHA256SUMS.txt:"
          cat SHA256SUMS.txt

      - name: Generate release notes
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          cat > release/RELEASE_NOTES.md << EOF
          # MJML Binary $VERSION

          Standalone MJML binaries - no Node.js installation required.

          ## Quick Start

          \`\`\`bash
          # Download and extract
          curl -L https://github.com/${{ github.repository }}/releases/download/$VERSION/mjml-linux-x64-node20.zip -o mjml.zip
          unzip mjml.zip

          # Make executable & run
          chmod +x mjml-linux-x64-node20
          ./mjml-linux-x64-node20 input.mjml -o output.html
          \`\`\`

          ## Downloads

          | Platform | Architecture | Node 16 | Node 18 | Node 20 | Node 22 |
          |----------|-------------|---------|---------|---------|---------|
          | macOS | Intel (x64) | [Download](../../releases/download/$VERSION/mjml-darwin-x64-node16.zip) | [Download](../../releases/download/$VERSION/mjml-darwin-x64-node18.zip) | [Download](../../releases/download/$VERSION/mjml-darwin-x64-node20.zip) | [Download](../../releases/download/$VERSION/mjml-darwin-x64-node22.zip) |
          | macOS | Apple Silicon | [Download](../../releases/download/$VERSION/mjml-darwin-arm64-node16.zip) | [Download](../../releases/download/$VERSION/mjml-darwin-arm64-node18.zip) | [Download](../../releases/download/$VERSION/mjml-darwin-arm64-node20.zip) | [Download](../../releases/download/$VERSION/mjml-darwin-arm64-node22.zip) |
          | Linux | x64 | [Download](../../releases/download/$VERSION/mjml-linux-x64-node16.zip) | [Download](../../releases/download/$VERSION/mjml-linux-x64-node18.zip) | [Download](../../releases/download/$VERSION/mjml-linux-x64-node20.zip) | [Download](../../releases/download/$VERSION/mjml-linux-x64-node22.zip) |
          | Linux | arm64 | [Download](../../releases/download/$VERSION/mjml-linux-arm64-node16.zip) | [Download](../../releases/download/$VERSION/mjml-linux-arm64-node18.zip) | [Download](../../releases/download/$VERSION/mjml-linux-arm64-node20.zip) | [Download](../../releases/download/$VERSION/mjml-linux-arm64-node22.zip) |

          ## Verification

          \`\`\`bash
          shasum -a 256 -c SHA256SUMS.txt
          \`\`\`

          ---
          *Built from commit ${{ github.sha }}*
          EOF

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          gh release create "$VERSION" \
            --repo "${{ github.repository }}" \
            --title "MJML Binary $VERSION" \
            --notes-file release/RELEASE_NOTES.md \
            release/*.zip \
            release/SHA256SUMS.txt

      - name: Release Summary
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "                 ðŸŽ‰ Release Created!                        "
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "   Version: $VERSION"
          echo "   Assets:  $(ls -1 release/*.zip | wc -l) ZIP files"
          echo ""
          echo "   URL: https://github.com/${{ github.repository }}/releases/tag/$VERSION"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
